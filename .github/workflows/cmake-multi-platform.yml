name: CMake Multi-Platform

permissions:
  contents: write
  packages: read

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        fetch-depth: 0

    - name: Get version from tag
      id: get_version
      shell: bash
      run: |
        if [ "${{ github.ref_type }}" = "tag" ]; then
          VERSION="${{ github.ref_name }}"
          VERSION=${VERSION#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          echo "is_release=true" >> $GITHUB_OUTPUT
        else
          VERSION="dev-${{ github.sha }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=" >> $GITHUB_OUTPUT
          echo "is_release=false" >> $GITHUB_OUTPUT
        fi

    - name: Install Linux dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libsdl2-dev \
          libsdl2-image-dev \
          libsidplayfp-dev \
          pkg-config

    - name: Configure CMake
      run: cmake -B build -S . -DENABLE_CLOUD_SAVE=ON -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release -j$(nproc)

    - name: Prepare Linux artifacts
      run: |
        mkdir -p artifacts/linux
        VERSION="${{ steps.get_version.outputs.version }}"
        cp build/bin/imSidPlayer artifacts/linux/
        strip artifacts/linux/imSidPlayer || true
        cp -r fonts artifacts/linux/
        cp -r certs artifacts/linux/
        
        if [ "${{ steps.get_version.outputs.is_release }}" = "true" ]; then
          cp artifacts/linux/imSidPlayer "artifacts/linux/imSidPlayer-${VERSION}-linux"
        fi

    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: imSidPlayer-linux${{ steps.get_version.outputs.is_release && format('-{0}', steps.get_version.outputs.version) || '' }}
        path: artifacts/linux/
        retention-days: 30

  build-windows:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/${{ github.repository_owner }}/imsidplayer/imsidplayer-windows:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    env:
      CC: x86_64-w64-mingw32-gcc
      CXX: x86_64-w64-mingw32-g++
      PATH: /usr/x86_64-w64-mingw32/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      SIDPLAYFP_ROOT: /usr/x86_64-w64-mingw32
      PKG_CONFIG_PATH: /usr/x86_64-w64-mingw32/lib/pkgconfig
      PKG_CONFIG_LIBDIR: /usr/x86_64-w64-mingw32/lib/pkgconfig
      PKG_CONFIG_SYSROOT_DIR: /
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        fetch-depth: 0

    - name: Get version from tag
      id: get_version
      shell: bash
      run: |
        if [ "${{ github.ref_type }}" = "tag" ]; then
          VERSION="${{ github.ref_name }}"
          VERSION=${VERSION#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          echo "is_release=true" >> $GITHUB_OUTPUT
        else
          VERSION="dev-${{ github.sha }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=" >> $GITHUB_OUTPUT
          echo "is_release=false" >> $GITHUB_OUTPUT
        fi

    - name: Prepare Python environment
      run: |
        python3 -m venv venv
        . venv/bin/activate
        pip install --upgrade pip
        pip install "jsonschema>=3.0.0,<4.0.0" jinja2

    - name: Configure CMake
      run: |
        . venv/bin/activate
        cmake -B build-win -S . \
          -DCMAKE_SYSTEM_NAME=Windows \
          -DCMAKE_C_COMPILER=$CC \
          -DCMAKE_CXX_COMPILER=$CXX \
          -DCMAKE_BUILD_TYPE=Release \
          -DENABLE_CLOUD_SAVE=ON \
          -DPython3_EXECUTABLE=$(pwd)/venv/bin/python3 \
          -DCMAKE_FIND_ROOT_PATH=/usr/x86_64-w64-mingw32 \
          -DSDL2_DIR=/usr/x86_64-w64-mingw32/lib/cmake/SDL2

    - name: Build
      run: |
        . venv/bin/activate
        cmake --build build-win --config Release -j$(nproc)

    - name: Prepare Windows artifacts (Install)
      run: |
        cmake --install build-win --prefix artifacts/windows
        # Nettoyage des fichiers de dev inutiles dans le bundle
        rm -rf artifacts/windows/include artifacts/windows/lib artifacts/windows/share

    - name: Create Windows Zip (Release only)
      if: steps.get_version.outputs.is_release == 'true'
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        # zip est d√©j√† dans l'image
        cd artifacts/windows
        zip -r "../imSidPlayer-${VERSION}-windows.zip" .
        cd ../..

    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: imSidPlayer-windows${{ steps.get_version.outputs.is_release && format('-{0}', steps.get_version.outputs.version) || '' }}
        path: artifacts/
        retention-days: 30

  release:
    needs: [build-linux, build-windows]
    if: github.ref_type == 'tag' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Get version from tag
        id: get_version
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION=${VERSION#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: imSidPlayer-linux-${{ steps.get_version.outputs.version }}
          path: release-artifacts/linux

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: imSidPlayer-windows-${{ steps.get_version.outputs.version }}
          path: release-artifacts/windows

      - name: Prepare release files
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          mkdir -p release-files
          
          # Linux binary
          if [ -f "release-artifacts/linux/imSidPlayer-$VERSION-linux" ]; then
            cp "release-artifacts/linux/imSidPlayer-$VERSION-linux" "release-files/imSidPlayer-$VERSION-linux"
            chmod +x "release-files/imSidPlayer-$VERSION-linux"
          fi
          
          # Windows zip
          if [ -f "release-artifacts/windows/imSidPlayer-$VERSION-windows.zip" ]; then
            cp "release-artifacts/windows/imSidPlayer-$VERSION-windows.zip" "release-files/imSidPlayer-$VERSION-windows.zip"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.tag }}
          name: Release ${{ steps.get_version.outputs.tag }}
          body: |
            ## imSid Player ${{ steps.get_version.outputs.version }} (Alpha)
            
            ‚ö†Ô∏è **This is an alpha release - Work In Progress**
            
            ## üì¶ Downloads
            
            ### Linux
            - **[Download imSidPlayer-${{ steps.get_version.outputs.version }}-linux](https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.tag }}/imSidPlayer-${{ steps.get_version.outputs.version }}-linux)**
            
            ### Windows
            - **[Download imSidPlayer-${{ steps.get_version.outputs.version }}-windows.zip](https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.tag }}/imSidPlayer-${{ steps.get_version.outputs.version }}-windows.zip)**
            
            ---
          files: release-files/*
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
